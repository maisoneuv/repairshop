# Generated by Django 5.0.10 on 2025-12-08 21:19

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('tasks', '0034_alter_task_summary'),
        ('tenants', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='FormTemplate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('form_type', models.CharField(choices=[('intake', 'Intake Form'), ('invoice', 'Invoice'), ('quote', 'Quote'), ('receipt', 'Receipt'), ('work_order', 'Work Order')], db_index=True, default='intake', max_length=50)),
                ('name', models.CharField(help_text="Template name (e.g., 'Default Intake Form', 'Premium Invoice')", max_length=200)),
                ('html_content', models.TextField(help_text='HTML template with {{variable}} placeholders')),
                ('is_active', models.BooleanField(default=False, help_text='Only one template per form type can be active per tenant')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_templates', to=settings.AUTH_USER_MODEL)),
                ('tenant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='form_templates', to='tenants.tenant')),
            ],
            options={
                'verbose_name': 'Form Template',
                'verbose_name_plural': 'Form Templates',
                'ordering': ['-is_active', '-updated_at'],
                'permissions': [('manage_templates', 'Can create, edit, and delete form templates')],
            },
        ),
        migrations.CreateModel(
            name='FormDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('form_type', models.CharField(db_index=True, help_text='Denormalized for quick filtering', max_length=50)),
                ('file_path', models.CharField(help_text='Relative path to the generated PDF file', max_length=500)),
                ('generated_at', models.DateTimeField(auto_now_add=True)),
                ('status', models.CharField(choices=[('success', 'Success'), ('error', 'Error'), ('pending', 'Pending')], db_index=True, default='pending', max_length=20)),
                ('error_message', models.TextField(blank=True, help_text='Error details if generation failed', null=True)),
                ('generated_by', models.ForeignKey(blank=True, help_text='User who generated the document. Null = auto-generated', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='generated_documents', to=settings.AUTH_USER_MODEL)),
                ('tenant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='form_documents', to='tenants.tenant')),
                ('work_item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='form_documents', to='tasks.workitem')),
                ('template', models.ForeignKey(blank=True, help_text='Template used to generate this document (nullable if template deleted)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='generated_documents', to='documents.formtemplate')),
            ],
            options={
                'verbose_name': 'Form Document',
                'verbose_name_plural': 'Form Documents',
                'ordering': ['-generated_at'],
            },
        ),
        migrations.AddConstraint(
            model_name='formtemplate',
            constraint=models.UniqueConstraint(condition=models.Q(('is_active', True)), fields=('tenant', 'form_type'), name='unique_active_form_per_type'),
        ),
        migrations.AddIndex(
            model_name='formdocument',
            index=models.Index(fields=['work_item', 'form_type'], name='documents_f_work_it_cf9244_idx'),
        ),
        migrations.AddIndex(
            model_name='formdocument',
            index=models.Index(fields=['tenant', 'form_type', 'status'], name='documents_f_tenant__59311d_idx'),
        ),
    ]
