# Generated by Django 5.0.10 on 2025-12-22

from django.db import migrations


def populate_picklist_values(apps, schema_editor):
    """Create initial picklist values for all existing tenants from hardcoded choices"""
    Tenant = apps.get_model('tenants', 'Tenant')
    PicklistValue = apps.get_model('core', 'PicklistValue')

    # Define the hardcoded choices to migrate
    PICKLIST_DEFINITIONS = {
        'workitem_status': [
            ('New', 'New', 0),
            ('In Progress', 'In Progress', 1),
            ('Resolved', 'Resolved', 2),
        ],
        'task_status': [
            ('To do', 'To do', 0),
            ('In progress', 'In progress', 1),
            ('Done', 'Done', 2),
            ('Reopened', 'Reopened', 3),
        ],
        'currency': [
            ('USD', 'US Dollar', 0),
            ('EUR', 'Euro', 1),
            ('GBP', 'British Pound', 2),
        ],
    }

    # Create picklist values for all existing tenants
    tenants = Tenant.objects.all()

    for tenant in tenants:
        for category, values in PICKLIST_DEFINITIONS.items():
            for value, name, sort_order in values:
                PicklistValue.objects.get_or_create(
                    tenant=tenant,
                    category=category,
                    value=value,
                    defaults={
                        'name': name,
                        'sort_order': sort_order,
                        'is_active': True,
                        'is_system': True,  # Mark original values as system-protected
                    }
                )


def reverse_populate(apps, schema_editor):
    """Remove all picklist values"""
    PicklistValue = apps.get_model('core', 'PicklistValue')
    PicklistValue.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0014_add_picklist_model'),
        ('tenants', '0001_initial'),  # Ensure tenant model is available
    ]

    operations = [
        migrations.RunPython(populate_picklist_values, reverse_populate),
    ]
